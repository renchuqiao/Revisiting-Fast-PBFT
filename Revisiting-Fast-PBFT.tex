%!TEX program = xelatex
\documentclass[UTF8]{ctexart}

\usepackage{authblk}

\usepackage{graphicx,url}
\usepackage{mathtools}

\usepackage[utf8]{inputenc}

\usepackage{cleveref}

% UTF-8 encoding is recommended by ShareLaTex
\usepackage{verbatim}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{ upgreek }

\def\lc{\left\lceil}
\def\rc{\right\rceil}

\definecolor{verde}{rgb}{0,0.5,0}

\newtheorem*{generation}{生成}
\newtheorem*{derive}{衍生}
\newtheorem*{sign}{签名}
\newtheorem*{verify}{验证}

\crefformat{section}{\S#2#1#3}


\lstset{language=C,
              belowcaptionskip=1\baselineskip,
                breaklines=true,
                frame=false,
                xleftmargin=\parindent,
                showstringspaces=false,
                basicstyle=\footnotesize\ttfamily,
                keywordstyle=\bfseries\color{green!40!black},
                commentstyle=\itshape\color{purple!40!black},
                identifierstyle=\color{blue},
                stringstyle=\color{orange},
                numbers=left,
            }

\sloppy

\title{重温快速实用拜占庭容错算法}

%\author{WeiWu Zhang\inst{1}, Tore K Frederiksen\inst{2}著, cr025\inst{3}译}
\author{Ittai Abraham 著 \and Guy Gueta 著 \and Dahlia Malkhi, VMware Research 著 \and cr025, EthFans China, rchuqiao@gmail.com译}
%\address{AlphaWallet, Singapore
%\nextinstitute Alexandra Institute, Denmark
%\nextinstitute EthFans
  %\email{weiwu.zhang@awallet.io, tore.frederiksen@alexandra.dk}
%}

\begin{document}

\maketitle

\begin{abstract}
在这份说明中， 我们发现了一个象鼻虫系统(Zyzzyva)的安全漏洞[7, 9, 8]以及FaB系统中的活跃度违规[14,15]。为了展示这些问题，我们设定了一些简单的场景，包括四个复制和一到两个检视(view)变化。在如上所有的场景中我们能从第一个日志时间段中发现问题
\end{abstract}

\section{引言}
Castro和Liskov提出的实用拜占庭容错算法(PBFT)[3, 4]是一个里程碑式的方法，它使得拜占庭容错算法可以有复制(replication)。在PBFT提出之后，很多学者都致力于提高PBFT协议的效率。其中一个分支围绕着乐观性(optimism)展开[10, 14, 15, 7, 9, 8, 5, 2]。在这条分支上，焦点在于如何提供一个快速的常用例（比如没有链接或者服务器错误）。在其他情况下， 乐观解法倒退回一些有强大进程保证的替补方案。

在这份说明中，我们发现在乐观分支下的一些重要研究并没有正确的处理乐观性(optimism)。我们在第二部分展示了象鼻虫系统(Zyzzyva)的安全漏洞[7, 9, 8]。我们在第三部分展示了FaB系统[14, 15]如何被其“过分安全”的特征卡住。为了展示这些问题，我们设定了一些简单的场景，包括四个复制和一到两个检视(view)变化。在如上所有的场景中我们能从第一个日志时间段中发现问题
我们如下也发现了在其他快速拜占庭复制方案中，乐观的分支没有完全和正常的协议关联，因此他们不是很快速。

因此在[12]中发布的关于提供拜占庭快速Paxos算法的挑战依然存在：
\begin{quotation}
“快速Paxos算法可以被扩展到快速拜占庭Paxos算法，在没有碰撞的情况下，协议与学习之间只需要两个信息延迟（然而，一个不怀好意的提议者可以自己创建一个碰撞）。”[12]
\end{quotation}

也就是说，没有一个我们所知的快速拜占庭协议可以提供一个可以同时解决如下四种情况的方案: (1) 优化步骤的复杂度 (2) 优化弹性 (3) 保持系统免于少于系统总量三分之一的故障 (4) 在部分同步的期间保持进程。

我们已经做出了一个完整的解决方案，并会在不久的未来发布后续的文章。


\subsection*{前文} \label{sec:firstpage}
这个文章的重点是为$n$个复制提供复制状态机(SMR)，这里的$f$是拜占庭错误。一个无界的用户组会发送一系列请求给复制机。我们把系统中不论是复制机还是用户都统称为节点(node)。节点之间的通讯都是被认证，可信和异步的；换言之，我们假设从一个有效的节点发送给另一个有效节点的信息是经过认证并且最终会到达。

SMR的核心是一个对用户请求日志裁定的增长施行决策的协议，需要满足如下的特征：

\textbf{协议} \hspace{3mm} 如果两个有效的复制机在同一个日志点$s$施行了决策，那么这个决策一定是一样的

\textbf{合法性} \hspace{3mm} 如果一个有效的复制机在日志的$s$位置做出了决断，那么这个（认证后的）决断一定是某个用户的请求 

\textbf{活跃度} \hspace{3mm} 如果一些有效的用户发送了请求，以及这个系统最终是部分同步的(partially-synchronous)[6]，那么最终复制机会做出一些决断。

\subsection*{检视变化(View Change)}
我们讨论的方案设计到一个经典的框架，它通过检视次数来明确的把提案排名。
 
所有的复制机都从一个初始的检视开始，从一个检视过渡到另一个。他们仅接受并回复当前检视里的请求。

在每个检视中有且仅有唯一的一个特定的领导者(leader)。在一个检视中，可能有零个或是多个决定。这样的策略把安全性从活跃度剥离开：即使系统展现出了任意的交流延迟并出现$f$拜占庭错误，它都能保证系统的安全性。它可以在同步的时期提供进展。

如果有足够数量的复制机怀疑领导者出现错误，那么检视就会变化并且一个新的领导者会被选出。这种触发改变到更高的检视的机制不会对安全性造成影响但是却对于活跃度非常重要。一方面，复制机不应该停滞在一个检视中没有进展；另一方面，他们也不应该反复无常的转移到更高的检视中，因为这样会阻碍任何检视的进展。因此，一个复制机应该转移到更高的检视中如果一个本地计时器过期了或者它从$f+1$个复制机处接收到了新检视的建议。活跃度依赖于系统中固定百分比的检视都有一个正确的领导者，并且这个领导者与有效复制机的交流是及时的，这样就防止$f+1$个复制机过期。

安全性和活跃度的巅峰是如何处理领导者的替换。在失败后重新获得一致意见最核心的方面是新的领导者如何安全的继承上一个领导者的数据。原因很简单，前一任领导者可能已经做出了一个裁决，那么最安全的做法就是继承这个决定。

在良性环境中占优势的解决方案(DLS [6], Paxos [11], VR [16], Raft [17])中，从法定上选出的$n - f$个复制机中选出有最多次检视变化的人来替换现有领导者。注意在这里的$n - f$个复制机所代表的法定人数应该和前面所有(不仅仅是最近的几个)检视中的领导者的法定人数有交集。更重要的是我们要考虑到前几次检视的领导者法定人数是如何相互影响的。选择具有最大检视次数的决定是非常重要的，因为从几个相互冲突的决定中随机性的选择一个不一定永远是安全的。

PBFT [3, 4]有一个相似的范例。新的领导者需要从$n - f$个法定复制机上读数据并选择一个有最多检视的值。和良性环境不同的是，在拜占庭环境下，独特性是由一个更大的拜占庭法定人数[13]实现的。拜占庭法定人数保证了任意节点不只是有效节点之间的交集。

在拜占庭设定下，一个有效节点也需要向新的领导者证明决策。在PBFT中这个过程是在形成决策前加入一个新的阶段。第一阶段是通过在$n - f$个节点上准备信息(prepare message)的方式保证独特性。在第二个阶段，节点发送一个由$n - f$个准备信息(prepare message)组成的保证证书(commit-certificate)。当$n - f$个节点发送了保证证书，决定就形成了。一旦一个决定形成了，这样的双阶段模式保证了一定会有一个有效节点发送了保证证书到下一个检视。

\subsection*{牺牲弹性}
PBFT额外的阶段也许可以由牺牲弹性并用$n = 5f + 1$来避免，就像在FaB[14, 15]，象鼻虫[5, 7]， 和Q/U[1]一样。这里，一个潜在决定的法定人群和一个检视变更的法定人群的交集有$2f + 1$个有效节点，足够用来提供独特性和价值转移。

\subsection*{Kursawe的解决方案}
Kursawe在2002年提供了一个简单的黑箱技能在有限的范围里把任何异步拜占庭协议(有足够强的合法性性质)转化成一个有最快速优化路线的共识协议。它是这么运作的：

在系统中有两个可能的达成一致的路线，他们有可能被合并(有一些节点加入快速的路线有一些不)。在快速路线中，如果所有的节点准备了同样的数值那么一个节点就能形成决策。在备用路线上，任何拜占庭协议被调用时节点用它们的准备值作为起始输入值。协议的唯一需求是它需要满足如下的合法性属性：

\textbf{拜占庭合法性} \hspace{3mm} 如果所有的有效节点都从一个输入址$v$开始，那么最后的决定值一定是$v$。

这个简洁的解决方案是(近似于毋庸置疑)正确的。然而，在恢复的阶段我们并没有用到快速路线中已经完成的准备步骤。因此，虽然快速路线是快速的，备用路线缺不是最优化的。

此外，如我们提到的，这种解决方案仅局限在一个有限的范围里：它仅仅解决了一次性的共识，却完全没有解决复制状态机(的执行)问题。

\subsection*{FaB}
FaB[14, 15]在多个方面扩展了Kursawe的方法。首先，快速路线中的准备信息传送到了恢复阶段，因此减少了恢复模式中的步数。由此，FaB的恢复模式与PBFT有相同的总成本。其次，FaB扩展了对一个参数化错误模型$n = 3f + 2t + 1$的处理。因此，如果我们合理的增加系统的大小，即使有$t$个非领导者拜占庭错误，快速终止依然可以完成，并对$f$保证了安全性。

为了达到这样的增强效果，FaB不能把在恢复阶段的拜占庭协议当作一个黑箱子。不幸的是，开放恢复协议以及把共识步骤加入到FaB框架导致了我们接下来会提及的疏忽(参照\cref{sec:FaB})。

\subsection*{象鼻虫系统}
象鼻虫系统从FaB系统借鉴了把优化快速路线和恢复路线有效融合的方法。在此基础上它提高了各个方面。相比于FaB仅仅是一次的共识解决方案，象鼻虫系统提供了一个状态复制机协议。在象鼻虫系统中状态更新使用了投机形式，使得状态复制机复制的通道可以实现高吞吐量，这个在FaB系统中是没有的。最后，在象鼻虫系统中一个新的领导者不能像在FaB中一样卡在选择“安全”值的步骤。不幸的是，在象鼻虫系统中的检视变更协议无法阻止有缺陷的领导者所造成的安全隐患，这点会在\cref{sec:Zyzzyva}中详细阐述。

\subsection*{Upright}
象鼻虫系统的检视变更协议用的是UpRight[5], 它和FaB一样包含$n = 3f + 2t + 1$失误模型。UpRight的目标是创造出一种以工程为优势的BFT引擎。UpRight论文中并没有对算法做出一个具体的介绍，它只是指出UpRight借鉴了前两种解决方案。

\subsection*{下一个700BFT协议}
在“下一个700BFT协议”中，Aublin及他人[2]提出了一个在BFT协议中关于检视变更的原则性方案。他们的方案不仅转换了领导者们，也转换了整个组织方式，使它们都能回应系统的自适性状态。700BFT协议家族中的一个节点是AZyzzyva，它结合了象鼻虫系统中的投机（快速）路线，Zlight协议以及一个恢复协议，比如PBFT。如果Zlight没有进度，这个系统就会切换到新的检视，运行一个固定$k$个PBFT日志时段。因此AZyzzyva有Kursawe作为替补的同时也增加了众多状态机命令以及实现一个复制的状态机。Azyzzyva实际上是简单且原则性的，并且它并没有我们将会在\cref{sec:Zyzzyva}提到的安全违规。同时，Azyzzyva的恢复路线比有两个阶段的象鼻虫协议需要更多的步骤。除此之外，Azyzzyva需要等到一个(有$k$个时段的)承诺决定(commit decision)来从PBFT切换到Zlight。

\section{再谈象鼻虫系统的检视变更}\label{sec:Zyzzyva}
\subsection{前言}

\subsection{象鼻虫协议的概括}

\section{再谈FaB的检视变更}\label{sec:FaB}
略略略

\subsection*{参考}
暂略

\end{document}
